<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowchart Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6EE7B7 0%, #A7F070 100%);
            --secondary-gradient: linear-gradient(135deg, #3B82F6 0%, #9333EA 100%);
            --background-dark: #1E1E1E;
            --text-light: #F3F4F6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-light);
        }

        .btn-grad {
            background-image: var(--primary-gradient);
            color: #000;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease-in-out;
        }

        .btn-grad:hover {
            background-image: var(--secondary-gradient);
            color: white;
            transform: scale(1.05);
        }

        .bg-stripe {
            background: var(--background-dark) repeating-linear-gradient(
                45deg,
                transparent,
                transparent 7px,
                rgba(255, 255, 255, 0.03) 9px,
                rgba(255, 255, 255, 0.03) 13px,
                transparent 13px,
                transparent 21px
            );
        }

        .input-custom, .select-custom {
            background-color: #2D3748;
            border: 1px solid #4A5568;
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
        }

        .input-custom:focus, .select-custom:focus {
            outline: none;
            border-color: #4299E1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }

        .title-gradient {
            background-image: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .mermaid svg {
            width: 100%; /* Adjust this value as needed */
            height: auto; /* This will maintain the aspect ratio */
            max-width: 100%;
            max-height: 100%;
        }
        #chartContainer {
            width: 90vw; /* Control the width based on viewport width */
            height: 90vh; /* Adjust height as needed, here using viewport height */
            min-height: 500px; /* Ensures a minimum height */
            min-width: 800px;
        }
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background-color: #1a202c;
            overflow-y: auto;
            padding: 1rem;
          }
        
          .card {
            background-color: #2d3748;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
          }
        
          .sidebar select,
          .sidebar input[type="number"],
          .sidebar input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
          }
          .sidebar-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
          }

          .sidebar-input {
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
          }
        
          .sidebar label {
            display: block;
            margin-bottom: 0.25rem;
            color: #a0aec0;
          }
        
          @media (max-width: 640px) {
            .sidebar {
              width: 100%;
              height: auto;
              position: static;
            }
           
          }

    </style>
</head>
<body class="bg-stripe">
    <div class="sidebar fixed left-0 top-0 bottom-0 w-64 bg-gray-900 p-6 overflow-y-auto">
        <div class="card bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
          <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500 mb-6">AI Flowchart</h2>
          <div class="flex flex-col gap-4 mb-4 w-full">
            <label for="llmProvider" class="text-gray-300 font-semibold">LLM Provider</label>
            <select id="llmProvider" class="p-2 rounded bg-gray-700 text-white">
              <option value="">Select Provider</option>
              {% for llm in available_llms %}
                <option value="{{ llm.value }}">{{ llm.label }}</option>
              {% endfor %}
            </select>
      
            <div id="modelSelection">
              <label for="llmModel" class="text-gray-300 font-semibold">Model</label>
              <select id="llmModel" class="p-2 rounded bg-gray-700 text-white" disabled>
                <option value="">Select Model</option>
              </select>
            </div>
      
            <div id="manualModelInput" style="display: none;">
              <label for="manualModel" class="text-gray-300 font-semibold">Model Name</label>
              <input type="text" id="manualModel" placeholder="Enter model name" class="p-2 rounded bg-gray-700 text-white">
            </div>
      
            <label for="apiKey" class="text-gray-300 font-semibold">API Key</label>
            <input type="password" id="apiKey" placeholder="Enter API Key" class="p-2 rounded bg-gray-700 text-white">
            
            <label for="temperature" class="text-gray-300 font-semibold">Temperature</label>
            <input type="number" id="temperature" min="0" max="1" step="0.1" class="p-2 rounded bg-gray-700 text-white" value="0.7">
      
            <label for="maxTokens" class="text-gray-300 font-semibold">Max Tokens</label>
            <input type="number" id="maxTokens" min="1" max="4096" step="1" class="p-2 rounded bg-gray-700 text-white" value="1024">
          </div>
        </div>
      </div>
      
      <div class="container mx-auto px-4 py-8 min-h-screen flex flex-col">
        <div class="flex-grow flex flex-col justify-center items-center">
            <div id="chartContainer" style="width: 90vw; height: auto;" class="w-90vw max-w-4xl bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <div id="loadingIndicator" class="hidden flex flex-col justify-center items-center">
              <h1 class="text-4xl font-bold text-gray-300">Loading...</h1>
            </div>
            <div id="chart" class="hidden"></div>
            <div id="initialContent" class="text-center py-12">
              <h1 class="text-6xl font-bold title-gradient mb-4">Generate</h1>
              <h3 class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500 mb-2">Flowchart</h3>
              <h2 class="text-4xl font-bold text-gray-300">with AI</h2>
            </div>
          </div>
      
          <form id="flowchartForm" class="w-full max-w-2xl">
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
              <input id="inputField" class="flex-grow p-2 rounded bg-gray-700 text-white" type="text" placeholder="What the flowchart is about" autofocus>
              <button type="submit" id="submitButton" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Generate</button>
            </div>
            <select id="templateSelect" class="w-full p-2 rounded bg-gray-700 text-white">
              {% for template in templates %}
                <option value="{{ template.value }}">{{ template.label }}</option>
              {% endfor %}
            </select>
          </form>
      
          <div id="exportOptions" class="hidden mt-6 flex gap-4">
            <button onclick="exportSvg()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Export SVG</button>
            <button onclick="copyMermaidCode()" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">Copy Mermaid Code</button>
          </div>
        </div>
      </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: "dark",
            securityLevel: "loose",
            fontFamily: "Fira Code",
        });

        let chart = '';
        const form = document.getElementById('flowchartForm');
        const inputField = document.getElementById('inputField');
        const submitButton = document.getElementById('submitButton');
        const templateSelect = document.getElementById('templateSelect');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const chartDiv = document.getElementById('chart');
        const initialContent = document.getElementById('initialContent');
        const exportOptions = document.getElementById('exportOptions');
        const llmProviderSelect = document.getElementById('llmProvider');
        const llmModelSelect = document.getElementById('llmModel');
        const modelSelection = document.getElementById('modelSelection');
        const manualModelInput = document.getElementById('manualModelInput');
        const manualModelField = document.getElementById('manualModel');

        llmProviderSelect.addEventListener('change', async () => {
        const provider = llmProviderSelect.value;
        if (['huggingface-openai', 'huggingface-text', 'ollama'].includes(provider)) {
            modelSelection.style.display = 'none';
            manualModelInput.style.display = 'block';
            manualModelField.value = '';
            manualModelField.placeholder = provider.startsWith('huggingface') ? 'Enter Hugging Face model name' : 'Enter Ollama model name';
        } else {
            modelSelection.style.display = 'block';
            manualModelInput.style.display = 'none';
            if (provider) {
            const response = await fetch(`/api/models?provider=${provider}`);
            const models = await response.json();
            llmModelSelect.innerHTML = '<option value="">Select Model</option>' + 
                models.map(model => `<option value="${model.value}">${model.label}</option>`).join('');
            llmModelSelect.disabled = false;
            } else {
            llmModelSelect.innerHTML = '<option value="">Select Model</option>';
            llmModelSelect.disabled = true;
            }
        }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('flowchartForm');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const chartDiv = document.getElementById('chart');
            const initialContent = document.getElementById('initialContent');
            const exportOptions = document.getElementById('exportOptions');
        
            // Initialize Mermaid
            mermaid.initialize({ startOnLoad: false, theme: 'dark' });
        
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Gather form data
                const input = document.getElementById('inputField').value;
                const selectedTemplate = document.getElementById('templateSelect').value;
                const provider = document.getElementById('llmProvider').value;
                const model = getSelectedModel();
                const apiKey = document.getElementById('apiKey').value;
                const temperature = parseFloat(document.getElementById('temperature').value);
                const maxTokens = parseInt(document.getElementById('maxTokens').value);
        
                if (!input || !provider || !model) {
                    alert('Please fill in all required fields.');
                    return;
                }
        
                loadingIndicator.classList.remove('hidden');
                chartDiv.classList.add('hidden');
                initialContent.classList.add('hidden');
                exportOptions.classList.add('hidden');

                try {
                    const res = await axios.post('/api/ask', {
                        input,
                        selectedTemplate,
                        provider,
                        model,
                        apiKey,
                        temperature,
                        maxTokens
                    });

                    if (res.data.text) {
                        chart = res.data.text;
                        // Clear previous content
                        chartDiv.innerHTML = '';
                        // Create a new div for Mermaid
                        const mermaidDiv = document.createElement('div');
                        mermaidDiv.className = 'mermaid';
                        mermaidDiv.textContent = chart;
                        chartDiv.appendChild(mermaidDiv);
                        // Re-run Mermaid rendering
                        mermaid.init(undefined, mermaidDiv);
                        chartDiv.classList.remove('hidden');
                        exportOptions.classList.remove('hidden');
                    } else {
                        throw new Error("Sorry! a small issue occurred");
                    }
                } catch (error) {
                    console.error(error);
                    chartDiv.innerHTML = '<p class="text-red-500 text-center py-4">Sorry! A small issue occurred</p>';
                    chartDiv.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-50');
                }
            });
        
            function getSelectedModel() {
                const provider = document.getElementById('llmProvider').value;
                if (['huggingface-openai', 'huggingface-text', 'ollama'].includes(provider)) {
                    return document.getElementById('manualModel').value.trim();
                } else {
                    return document.getElementById('llmModel').value;
                }
            }
        });

        function exportSvg() {
            const svgElement = document.querySelector('svg');
            if (!svgElement) {
                console.error('SVG not found');
                return;
            }
        
            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(svgElement);
            const svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(svgBlob);
        
            // Use a base name for the file, such as 'artists_chart'
            let baseName = 'artists_chart';
        
            // Append a timestamp for uniqueness
            let timestamp = new Date().toISOString().replace(/[:.-]/g, '_');
            let fileName = `${baseName}_${timestamp}.svg`;
        
            // Create a temporary link to trigger the download
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link); // Clean up
        }   


        async function copyMermaidCode() {
            try {
                await navigator.clipboard.writeText(chart);
                alert("Mermaid code copied to clipboard!");
            } catch (error) {
                console.error('Error copying Mermaid code:', error);
                alert('Error copying Mermaid code');
            }
        }
    </script>
</body>
</html>