<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowchart Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #34d5e0 0%, #A7F070 100%);
            --secondary-gradient: linear-gradient(135deg, #3B82F6 0%, #9333EA 100%);
            --background-dark: #1E1E1E;
            --text-light: #F3F4F6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-light);
        }

        .btn-grad {
          background-image: var(--primary-gradient);
          color: #000000 !important; /* text-black */
          font-weight: 600; /* font-semibold */
          padding: 0.5rem 1rem; /* py-2 px-4 */
          border-radius: 0.5rem; /* rounded-lg */
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-md */
          transition: all 0.3s ease-in-out; /* transition-all duration-300 ease-in-out */
      }
        
        .btn-grad:hover {
            background-image: var(--secondary-gradient);
            color: #FFFFFF; /* text-white */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* shadow-lg */
            transform: scale(1.05); /* transform scale-105 */
        }

        .bg-stripe {
            background: var(--background-dark) repeating-linear-gradient(
                45deg,
                transparent,
                transparent 7px,
                rgba(255, 255, 255, 0.03) 9px,
                rgba(255, 255, 255, 0.03) 13px,
                transparent 13px,
                transparent 21px
            );
        }

        .container {
          max-width: 80rem;
          margin: 0 auto; /* mx-auto */
          padding: 2rem 1rem; /* py-8 (top and bottom padding 32px), px-4 (left and right padding 16px) */
          min-height: 100vh; /* min-h-screen */
          display: flex; /* flex */
          flex-direction: column; /* flex-col */
          margin: 0 auto;
          padding: 1rem 1.5rem 2rem;
      }
      
        .card {
          background-color: #1F2937;
          border-radius: 0.75rem;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
          padding: 1.5rem;
          margin-bottom: 2rem;
          overflow: auto;
      }
      
      .card-body {
          padding: 1.5rem;
      }

        .input-custom {
          background-color: #374151; /* bg-gray-700 */
          border: 1px solid #4B5563; /* border-gray-600 */
          border-radius: 0.5rem; /* rounded-lg */
          padding: 0.5rem 1rem; /* py-2 px-4 */
          color: #F3F4F6; /* text-gray-100 */
          outline: none; /* focus:outline-none */
          transition: all 0.3s ease-in-out; /* transition-all duration-300 ease-in-out */
      }

        .input-custom:focus, .select-custom:focus {
            outline: none;
            border-color: #4299E1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }

        .title-gradient {
          color: transparent;
          background-clip: text;
          -webkit-background-clip: text;
          background-image: var(--primary-gradient);
      }
      
        #chartContainer {
          width: 90vw;
          max-width: 56rem;
          height: auto;
          min-height: 500px;
          overflow: auto;
      }
        #chart {
          width: 100%;
          height: 100%;
      }
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 250px;
        background-color: #1a202c;
        overflow-y: auto;
        padding: 1rem;
    }

      .sidebar select,
      .sidebar input[type="number"],
      .sidebar input[type="text"],
      .sidebar input[type="password"] {
          width: 100%;
          box-sizing: border-box;
          transition: all 0.3s ease;
          background-color: #374151;
          border: 1px solid #4B5563;
          border-radius: 0.5rem;
          padding: 0.5rem 1rem;
          color: #F3F4F6;
      }

      .sidebar-input:focus {
          outline: none;
          box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
      }

      .sidebar label {
          display: block;
          margin-bottom: 0.25rem;
          color: #a0aec0;
      }

        #submitButton {
          background-color: #3b82f6; /* bg-blue-500 */
          color: white;
        }
        
        #submitButton:hover {
          background-color: #2563eb; /* hover:bg-blue-600 */
        }
        
        /* Ensure the button retains its background and color when active or focused */
        #submitButton:focus, #submitButton:active {
          background-color: #3b82f6; /* bg-blue-500 */
          color: white;
          outline: none; /* Optional: removes the outline on focus */
        }

        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
      }
      
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @media (max-width: 640px) {
          .sidebar {
            width: 100%;
            height: auto;
            position: static;
          }
          .btn-grad {
            width: 100%; /* w-full */
        }

          
      }
           

    </style>
</head>
<body class="bg-stripe">
    <div class="sidebar">
        <div class="card">
          <h2 class="text-2xl font-bold title-gradient mb-6">Diagram Generator</h2>
          <div class="flex flex-col gap-4 mb-4 w-full">
            <label for="llmProvider">LLM Provider</label>
            <select id="llmProvider" class="input-custom">
              <option value="">Select Provider</option>
              {% for llm in available_llms %}
                <option value="{{ llm.value }}">{{ llm.label }}</option>
              {% endfor %}
            </select>
      
            <div id="modelSelection">
              <label for="llmModel">Model</label>
              <select id="llmModel" class="input-custom" disabled>
                  <option value="">Select Model</option>
              </select>
          </div>
      
          <div id="manualModelInput" style="display: none;">
            <label for="manualModel">Model Name</label>
            <input type="text" id="manualModel" placeholder="Enter model name" class="input-custom">
        </div>

        <label for="apiKey">API Key</label>
        <input type="password" id="apiKey" placeholder="Enter API Key" class="input-custom">
        
        <label for="temperature">Temperature</label>
        <input type="number" id="temperature" min="0" max="1" step="0.1" class="input-custom" value="0.2">

        <label for="maxTokens">Max Tokens</label>
        <input type="number" id="maxTokens" min="1" max="4096" step="1" class="input-custom" value="4096">
    </div>
  </div>
  </div>
      
      <div class="container">
        <div class="flex-grow flex flex-col justify-center items-center">
            <div id="chartContainer" class="card">
            <div id="loadingIndicator" class="hidden flex flex-col justify-center items-center">
              <h1 class="text-4xl font-bold text-gray-300">Loading...</h1>
            </div>
            <div id="chart" class="hidden"></div>
            <div id="initialContent" class="text-center py-12">
              <h1 class="text-6xl font-bold title-gradient mb-4">Generate</h1>
              <h3 class="text-9xl pb-3 font-black title-gradient mb-2">Diagrams</h3>
              <br>
              <h2 class="text-4xl font-bold text-gray-300">using AI</h2>
            </div>
          </div>
      
          <form id="flowchartForm" class="w-full max-w-2xl">
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
              <input id="inputField" class="input-custom flex-grow" type="text" placeholder="What the flowchart is about" autofocus>
              <button type="submit" id="submitButton" class="btn-grad">Generate</button>
            </div>
            <select id="templateSelect" class="input-custom w-full">
              {% for template in templates %}
                <option value="{{ template.value }}">{{ template.label }}</option>
              {% endfor %}
            </select>
          </form>
      
          <div id="exportOptions" class="hidden mt-6 flex gap-4">
            <button onclick="exportSvg()" class="btn-grad">Export SVG</button>
            <button onclick="copyMermaidCode()" class="btn-grad">Copy Mermaid Code</button>
          </div>
        </div>
      </div>
    
    <script type="module">

      import zenuml from 'https://cdn.jsdelivr.net/npm/@mermaid-js/mermaid-zenuml@0.1.0/dist/mermaid-zenuml.esm.min.mjs';
      await mermaid.registerExternalDiagrams([zenuml]);

      mermaid.initialize({
        startOnLoad: true,
        theme: "dark",
        securityLevel: "loose",
        fontFamily: "Fira Code",
    });

    </script>

    <script>
        

        let chart = '';
        const form = document.getElementById('flowchartForm');
        const inputField = document.getElementById('inputField');
        const submitButton = document.getElementById('submitButton');
        const templateSelect = document.getElementById('templateSelect');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const chartDiv = document.getElementById('chart');
        const initialContent = document.getElementById('initialContent');
        const exportOptions = document.getElementById('exportOptions');
        const llmProviderSelect = document.getElementById('llmProvider');
        const llmModelSelect = document.getElementById('llmModel');
        const modelSelection = document.getElementById('modelSelection');
        const manualModelInput = document.getElementById('manualModelInput');
        const manualModelField = document.getElementById('manualModel');

        llmProviderSelect.addEventListener('change', async () => {
        const provider = llmProviderSelect.value;
        if (['huggingface-openai', 'huggingface-text', 'ollama'].includes(provider)) {
            modelSelection.style.display = 'none';
            manualModelInput.style.display = 'block';
            manualModelField.value = '';
            manualModelField.placeholder = provider.startsWith('huggingface') ? 'Enter Hugging Face model name' : 'Enter Ollama model name';
        } else {
            modelSelection.style.display = 'block';
            manualModelInput.style.display = 'none';
            if (provider) {
            const response = await fetch(`/api/models?provider=${provider}`);
            const models = await response.json();
            llmModelSelect.innerHTML = '<option value="">Select Model</option>' + 
                models.map(model => `<option value="${model.value}">${model.label}</option>`).join('');
            llmModelSelect.disabled = false;
            } else {
            llmModelSelect.innerHTML = '<option value="">Select Model</option>';
            llmModelSelect.disabled = true;
            }
        }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('flowchartForm');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const chartDiv = document.getElementById('chart');
            const initialContent = document.getElementById('initialContent');
            const exportOptions = document.getElementById('exportOptions');
        
        
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Gather form data
                const input = document.getElementById('inputField').value;
                const selectedTemplate = document.getElementById('templateSelect').value;
                const provider = document.getElementById('llmProvider').value;
                const model = getSelectedModel();
                const apiKey = document.getElementById('apiKey').value;
                const temperature = parseFloat(document.getElementById('temperature').value);
                const maxTokens = parseInt(document.getElementById('maxTokens').value);
        
                if (!input || !provider || !model) {
                    alert('Please fill in all required fields.');
                    return;
                }
        
                loadingIndicator.classList.remove('hidden');
                chartDiv.classList.add('hidden');
                initialContent.classList.add('hidden');
                exportOptions.classList.add('hidden');

                try {
                    const res = await axios.post('/api/ask', {
                        input,
                        selectedTemplate,
                        provider,
                        model,
                        apiKey,
                        temperature,
                        maxTokens
                    });

                    if (res.data.text) {
                        chart = res.data.text;
                        // Clear previous content
                        chartDiv.innerHTML = '';
                        // Create a new div for Mermaid
                        const mermaidDiv = document.createElement('div');
                        mermaidDiv.className = 'mermaid';
                        mermaidDiv.textContent = chart;
                        chartDiv.appendChild(mermaidDiv);
                        // Re-run Mermaid rendering
                        mermaid.init(undefined, mermaidDiv);
                        chartDiv.classList.remove('hidden');
                        exportOptions.classList.remove('hidden');
                    } else {
                        throw new Error("Sorry! a small issue occurred");
                    }
                } catch (error) {
                    console.error(error);
                    chartDiv.innerHTML = '<p class="text-red-500 text-center py-4">Sorry! A small issue occurred</p>';
                    chartDiv.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-50');
                }
            });
        
            function getSelectedModel() {
                const provider = document.getElementById('llmProvider').value;
                if (['huggingface-openai', 'huggingface-text', 'ollama'].includes(provider)) {
                    return document.getElementById('manualModel').value.trim();
                } else {
                    return document.getElementById('llmModel').value;
                }
            }
        });

        function exportSvg() {
          const svgElement = document.querySelector('svg');
          if (!svgElement) {
              console.error('SVG not found');
              return;
          }
      
          const serializer = new XMLSerializer();
          let svgContent = serializer.serializeToString(svgElement); // Correctly assign serialized SVG to svgContent
      
          // Optionally, adjust the SVG size here if needed
          const newWidth = '1600px';
          const newHeight = '1200px';
          svgContent = svgContent.replace(/width="[^"]*"/, `width="${newWidth}"`).replace(/height="[^"]*"/, `height="${newHeight}"`);
      
          const svgBlob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
          const url = URL.createObjectURL(svgBlob);
      
          let baseName = 'diagram_chart';
          let timestamp = new Date().toISOString().replace(/[:.-]/g, '_');
          let fileName = `${baseName}_${timestamp}.svg`;
      
          const link = document.createElement('a');
          link.href = url;
          link.setAttribute('download', fileName);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link); // Clean up
      }

        async function copyMermaidCode() {
            try {
                await navigator.clipboard.writeText(chart);
                alert("Mermaid code copied to clipboard!");
            } catch (error) {
                console.error('Error copying Mermaid code:', error);
                alert('Error copying Mermaid code');
            }
        }


      </script>
</body>
</html>